
server {
  listen 80;
  root /usr/share/nginx/html;
  index index.html;

  # Donâ€™t cache index.html (avoid SW/stale bundle surprises)
  location = /index.html {
    add_header "Cache-Control" "no-cache, no-store, must-revalidate" always;
    add_header "Pragma" "no-cache" always;
    add_header "Expires" "0" always;
    try_files /index.html =404;
  }

  # CORS (demo)
  add_header "Access-Control-Allow-Origin" "*" always;
  add_header "Access-Control-Allow-Methods" "GET, POST, OPTIONS, PUT, DELETE, PATCH" always;
  add_header "Access-Control-Allow-Headers" "*" always;

  # ---- Rewrite absolute localhost -> relative in JS bundles ----
  gzip off;
  sub_filter_types application/javascript text/javascript;
  sub_filter_once off;
  location /static/js/ {
    sub_filter "http://localhost:8080" "";
    try_files $uri $uri/ =404;
  }

  # SPA fallback
  location / { try_files $uri /index.html; }

  # Preflight short-circuit
  location = /sentiment { if ($request_method = OPTIONS) { return 204; } }
  location = /api/sentiment { if ($request_method = OPTIONS) { return 204; } }
  location /api/ { if ($request_method = OPTIONS) { return 204; } }

  # Proxies to Spring
  location = /sentiment {
    proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr;
    proxy_pass http://sa-web-app:8080/sentiment;
  }
  location = /api/sentiment {
    proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr;
    proxy_pass http://sa-web-app:8080/sentiment;
  }
  location /api/ {
    proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr;
    proxy_pass http://sa-web-app:8080/;
  }

  location = /health { return 200; }
}
